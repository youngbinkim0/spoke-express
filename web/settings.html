<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commute Optimizer - Settings</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: #1a73e8;
      color: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    header h1 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header a {
      color: white;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 1rem;
      color: #666;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card p {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 12px;
    }

    .input-group {
      margin-bottom: 12px;
    }

    .input-group label {
      display: block;
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 4px;
    }

    .address-input, .api-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }

    .coords-row {
      display: flex;
      gap: 12px;
    }

    .coords-row input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .station-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .station-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .station-item:hover {
      background: #f9f9f9;
    }

    .station-item:last-child {
      border-bottom: none;
    }

    .station-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      cursor: pointer;
    }

    .station-info {
      flex: 1;
    }

    .station-name {
      font-weight: 500;
    }

    .station-lines {
      font-size: 0.85rem;
      color: #666;
    }

    .station-distance {
      font-size: 0.85rem;
      color: #888;
    }

    .line-badge {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      color: white;
      font-size: 0.7rem;
      font-weight: bold;
      text-align: center;
      line-height: 20px;
      margin-right: 4px;
    }

    .line-G { background: #6CBE45; }
    .line-A, .line-C, .line-E { background: #0039A6; }
    .line-B, .line-D, .line-F, .line-M { background: #FF6319; }
    .line-N, .line-Q, .line-R, .line-W { background: #FCCC0A; color: #333; }
    .line-1, .line-2, .line-3 { background: #EE352E; }
    .line-4, .line-5, .line-6 { background: #00933C; }
    .line-7 { background: #B933AD; }
    .line-L { background: #A7A9AC; }
    .line-S, .line-FS, .line-H { background: #808183; }
    .line-J, .line-Z { background: #996633; }

    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      background: white;
    }

    .btn {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      margin-top: 16px;
    }

    .btn:hover {
      background: #1557b0;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .status {
      padding: 12px;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }

    .station-count {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 8px;
    }

    .help-text {
      font-size: 0.8rem;
      color: #888;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Settings</h1>
      <a href="index.html">‚Üê Back to Results</a>
    </header>

    <div id="content">
      <!-- API Key -->
      <div class="card">
        <h2>API Key</h2>
        <p>Get a free API key from <a href="https://openweathermap.org/api" target="_blank">OpenWeatherMap</a></p>
        <input type="text" id="apiKey" class="api-input" placeholder="Enter your OpenWeatherMap API key">
        <div class="help-text">Required for weather data. Free tier allows 1000 calls/day.</div>
      </div>

      <!-- Home Location -->
      <div class="card">
        <h2>Home Location</h2>
        <p>Your starting point for the commute</p>
        <div class="input-group">
          <label>Address (for reference)</label>
          <input type="text" id="homeAddress" class="address-input" placeholder="123 Main St, Brooklyn, NY">
        </div>
        <div class="coords-row">
          <div class="input-group">
            <label>Latitude</label>
            <input type="number" id="homeLat" step="0.0001" placeholder="40.6892">
          </div>
          <div class="input-group">
            <label>Longitude</label>
            <input type="number" id="homeLng" step="0.0001" placeholder="-73.9544">
          </div>
        </div>
        <div class="help-text">Tip: Right-click on Google Maps and select coordinates to copy them.</div>
      </div>

      <!-- Work Location -->
      <div class="card">
        <h2>Work Location</h2>
        <p>Your destination</p>
        <div class="input-group">
          <label>Address (for reference)</label>
          <input type="text" id="workAddress" class="address-input" placeholder="456 Office Ave, Manhattan, NY">
        </div>
        <div class="coords-row">
          <div class="input-group">
            <label>Latitude</label>
            <input type="number" id="workLat" step="0.0001" placeholder="40.7471">
          </div>
          <div class="input-group">
            <label>Longitude</label>
            <input type="number" id="workLng" step="0.0001" placeholder="-73.9456">
          </div>
        </div>
      </div>

      <!-- Bike-to Stations -->
      <div class="card">
        <h2>Bike-to Stations</h2>
        <p>Select stations you'd bike to from home</p>
        <div id="bikeStationCount" class="station-count"></div>
        <div id="bikeStations" class="station-list"></div>
      </div>

      <!-- Destination Station -->
      <div class="card">
        <h2>Destination Station</h2>
        <p>Station closest to your work</p>
        <select id="destStation"></select>
      </div>

      <!-- Live Train Stations -->
      <div class="card">
        <h2>Live Train Stations</h2>
        <p>Select up to 3 stations to display on the Live Trains page</p>
        <div id="liveStationCount" class="station-count"></div>
        <div id="liveStations" class="station-list"></div>
      </div>

      <button class="btn" id="saveBtn" onclick="saveSettings()">
        Save Settings
      </button>

      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    // Bundled station data (same as Android app)
    const STATIONS = [
      {"id": "G33", "name": "Bedford-Nostrand Avs", "lines": ["G"], "lat": 40.6896, "lng": -73.9535, "borough": "Brooklyn"},
      {"id": "G34", "name": "Classon Av", "lines": ["G"], "lat": 40.6889, "lng": -73.9600, "borough": "Brooklyn"},
      {"id": "G35", "name": "Clinton-Washington Avs (G)", "lines": ["G"], "lat": 40.6880, "lng": -73.9667, "borough": "Brooklyn"},
      {"id": "G36", "name": "Fulton St (G)", "lines": ["G"], "lat": 40.6870, "lng": -73.9752, "borough": "Brooklyn"},
      {"id": "A42", "name": "Hoyt-Schermerhorn Sts", "lines": ["A", "C", "G"], "lat": 40.6884, "lng": -73.9851, "borough": "Brooklyn"},
      {"id": "G31", "name": "Flushing Av", "lines": ["G"], "lat": 40.7004, "lng": -73.9504, "borough": "Brooklyn"},
      {"id": "G32", "name": "Myrtle-Willoughby Avs", "lines": ["G"], "lat": 40.6946, "lng": -73.9489, "borough": "Brooklyn"},
      {"id": "G30", "name": "Broadway (G)", "lines": ["G"], "lat": 40.7063, "lng": -73.9503, "borough": "Brooklyn"},
      {"id": "G29", "name": "Metropolitan Av", "lines": ["G"], "lat": 40.7127, "lng": -73.9511, "borough": "Brooklyn"},
      {"id": "G28", "name": "Nassau Av", "lines": ["G"], "lat": 40.7244, "lng": -73.9512, "borough": "Brooklyn"},
      {"id": "G26", "name": "Greenpoint Av", "lines": ["G"], "lat": 40.7313, "lng": -73.9542, "borough": "Brooklyn"},
      {"id": "G22", "name": "Court Sq", "lines": ["G", "7", "E", "M"], "lat": 40.7471, "lng": -73.9456, "borough": "Queens"},
      {"id": "G21", "name": "Long Island City-Court Sq", "lines": ["G"], "lat": 40.7460, "lng": -73.9436, "borough": "Queens"},
      {"id": "F09", "name": "Court Sq-23 St", "lines": ["E", "M"], "lat": 40.7479, "lng": -73.9461, "borough": "Queens"},
      {"id": "F11", "name": "21 St-Queensbridge", "lines": ["F"], "lat": 40.7543, "lng": -73.9424, "borough": "Queens"},
      {"id": "D24", "name": "Atlantic Av-Barclays Ctr", "lines": ["B", "Q", "D", "N", "R", "2", "3", "4", "5"], "lat": 40.6842, "lng": -73.9779, "borough": "Brooklyn"},
      {"id": "A41", "name": "Jay St-MetroTech", "lines": ["A", "C", "F", "R"], "lat": 40.6923, "lng": -73.9872, "borough": "Brooklyn"},
      {"id": "R30", "name": "DeKalb Av", "lines": ["B", "Q", "R"], "lat": 40.6907, "lng": -73.9818, "borough": "Brooklyn"},
      {"id": "R28", "name": "Borough Hall", "lines": ["2", "3", "4", "5", "R"], "lat": 40.6923, "lng": -73.9901, "borough": "Brooklyn"},
      {"id": "R16", "name": "Times Sq-42 St", "lines": ["1", "2", "3", "7", "N", "Q", "R", "W", "S"], "lat": 40.7559, "lng": -73.9871, "borough": "Manhattan"},
      {"id": "R17", "name": "34 St-Herald Sq", "lines": ["B", "D", "F", "M", "N", "Q", "R", "W"], "lat": 40.7497, "lng": -73.9878, "borough": "Manhattan"},
      {"id": "R20", "name": "14 St-Union Sq", "lines": ["4", "5", "6", "L", "N", "Q", "R", "W"], "lat": 40.7356, "lng": -73.9906, "borough": "Manhattan"},
      {"id": "631", "name": "Grand Central-42 St", "lines": ["4", "5", "6", "7", "S"], "lat": 40.7527, "lng": -73.9772, "borough": "Manhattan"},
      {"id": "A28", "name": "34 St-Penn Station", "lines": ["1", "2", "3", "A", "C", "E"], "lat": 40.7506, "lng": -73.9910, "borough": "Manhattan"}
    ];

    const STORAGE_KEY = 'commuteOptimizerSettings';

    function loadSettings() {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : {};
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 3959; // Earth's radius in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function init() {
      const settings = loadSettings();

      // Load saved values
      document.getElementById('apiKey').value = settings.apiKey || '';
      document.getElementById('homeAddress').value = settings.homeAddress || '';
      document.getElementById('homeLat').value = settings.homeLat || '';
      document.getElementById('homeLng').value = settings.homeLng || '';
      document.getElementById('workAddress').value = settings.workAddress || '';
      document.getElementById('workLat').value = settings.workLat || '';
      document.getElementById('workLng').value = settings.workLng || '';

      renderStations(settings);

      // Re-render stations when home coords change
      document.getElementById('homeLat').addEventListener('change', () => renderStations(loadSettings()));
      document.getElementById('homeLng').addEventListener('change', () => renderStations(loadSettings()));
    }

    function renderStations(settings) {
      const homeLat = parseFloat(document.getElementById('homeLat').value) || settings.homeLat || 0;
      const homeLng = parseFloat(document.getElementById('homeLng').value) || settings.homeLng || 0;

      // Calculate distances and sort
      const stationsWithDist = STATIONS.map(s => ({
        ...s,
        distance: homeLat ? calculateDistance(homeLat, homeLng, s.lat, s.lng) : 0
      })).sort((a, b) => a.distance - b.distance);

      // Render bike stations
      const bikeContainer = document.getElementById('bikeStations');
      const bikeStations = settings.bikeStations || [];

      document.getElementById('bikeStationCount').textContent =
        `${bikeStations.length} stations selected`;

      bikeContainer.innerHTML = stationsWithDist.map(s => `
        <label class="station-item">
          <input type="checkbox" name="bikeStation" value="${s.id}"
            ${bikeStations.includes(s.id) ? 'checked' : ''}>
          <div class="station-info">
            <div class="station-name">${s.name}</div>
            <div class="station-lines">
              ${s.lines.map(l => `<span class="line-badge line-${l}">${l}</span>`).join('')}
            </div>
          </div>
          <div class="station-distance">${s.distance.toFixed(2)} mi</div>
        </label>
      `).join('');

      // Render destination dropdown
      const destSelect = document.getElementById('destStation');
      destSelect.innerHTML = stationsWithDist.map(s => `
        <option value="${s.id}" ${settings.destStation === s.id ? 'selected' : ''}>
          ${s.name} (${s.lines.join('/')})
        </option>
      `).join('');

      // Default to Court Sq if not set
      if (!settings.destStation) {
        destSelect.value = 'G22';
      }

      // Render live train stations
      const liveContainer = document.getElementById('liveStations');
      const liveStations = settings.liveStations || [];

      document.getElementById('liveStationCount').textContent =
        `${liveStations.length}/3 stations selected`;

      liveContainer.innerHTML = stationsWithDist.map(s => `
        <label class="station-item">
          <input type="checkbox" name="liveStation" value="${s.id}"
            ${liveStations.includes(s.id) ? 'checked' : ''}
            onchange="checkLiveLimit(this)">
          <div class="station-info">
            <div class="station-name">${s.name}</div>
            <div class="station-lines">
              ${s.lines.map(l => `<span class="line-badge line-${l}">${l}</span>`).join('')}
            </div>
          </div>
          <div class="station-distance">${s.distance.toFixed(2)} mi</div>
        </label>
      `).join('');
    }

    function checkLiveLimit(checkbox) {
      const checked = document.querySelectorAll('input[name="liveStation"]:checked');
      if (checked.length > 3) {
        checkbox.checked = false;
        alert('You can select up to 3 stations.');
      }
      document.getElementById('liveStationCount').textContent =
        `${Math.min(checked.length, 3)}/3 stations selected`;
    }

    function saveSettings() {
      const status = document.getElementById('status');

      const settings = {
        apiKey: document.getElementById('apiKey').value.trim(),
        homeAddress: document.getElementById('homeAddress').value.trim(),
        homeLat: parseFloat(document.getElementById('homeLat').value) || 0,
        homeLng: parseFloat(document.getElementById('homeLng').value) || 0,
        workAddress: document.getElementById('workAddress').value.trim(),
        workLat: parseFloat(document.getElementById('workLat').value) || 0,
        workLng: parseFloat(document.getElementById('workLng').value) || 0,
        bikeStations: Array.from(document.querySelectorAll('input[name="bikeStation"]:checked'))
          .map(el => el.value),
        destStation: document.getElementById('destStation').value,
        liveStations: Array.from(document.querySelectorAll('input[name="liveStation"]:checked'))
          .map(el => el.value).slice(0, 3)
      };

      // Validate
      if (!settings.homeLat || !settings.homeLng) {
        status.className = 'status error';
        status.textContent = 'Please enter home coordinates.';
        return;
      }

      if (settings.bikeStations.length === 0) {
        status.className = 'status error';
        status.textContent = 'Please select at least one bike-to station.';
        return;
      }

      // Save to localStorage
      localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));

      status.className = 'status success';
      status.textContent = 'Settings saved!';

      // Update station counts
      document.getElementById('bikeStationCount').textContent =
        `${settings.bikeStations.length} stations selected`;

      setTimeout(() => {
        status.className = 'status';
      }, 3000);
    }

    init();
  </script>
</body>
</html>
