<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spoke Express - Settings</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: #1a73e8;
      color: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    header h1 {
      font-size: 1.5rem;
    }

    header a {
      color: white;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 1rem;
      color: #666;
      margin-bottom: 12px;
    }

    .card p {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 12px;
    }

    .input-group {
      margin-bottom: 12px;
    }

    .input-group label {
      display: block;
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 4px;
    }

    .address-row {
      display: flex;
      gap: 8px;
    }

    .address-input, .api-input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }

    .btn-lookup {
      padding: 12px 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-lookup:hover {
      background: #45a049;
    }

    .coords-row {
      display: flex;
      gap: 12px;
    }

    .coords-row .input-group {
      flex: 1;
    }

    .coords-row input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .geocode-status {
      font-size: 0.85rem;
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }

    .geocode-status.success {
      display: block;
      background: #d4edda;
      color: #155724;
    }

    .geocode-status.error {
      display: block;
      background: #f8d7da;
      color: #721c24;
    }

    .geocode-status.loading {
      display: block;
      background: #e2e3e5;
      color: #383d41;
    }

    .search-box {
      margin-bottom: 12px;
    }

    .search-box input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .station-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 6px;
    }

    .station-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .station-item:hover {
      background: #f9f9f9;
    }

    .station-item:last-child {
      border-bottom: none;
    }

    .station-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      cursor: pointer;
    }

    .station-info {
      flex: 1;
    }

    .station-name {
      font-weight: 500;
      font-size: 0.95rem;
    }

    .station-meta {
      font-size: 0.8rem;
      color: #888;
    }

    .station-lines {
      display: inline;
    }

    .station-distance {
      font-size: 0.85rem;
      color: #888;
      white-space: nowrap;
    }

    .line-badge {
      display: inline-block;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      color: white;
      font-size: 0.65rem;
      font-weight: bold;
      text-align: center;
      line-height: 18px;
      margin-right: 2px;
    }

    .line-G { background: #6CBE45; }
    .line-A, .line-C, .line-E { background: #0039A6; }
    .line-B, .line-D, .line-F, .line-M { background: #FF6319; }
    .line-N, .line-Q, .line-R, .line-W { background: #FCCC0A; color: #333; }
    .line-1, .line-2, .line-3 { background: #EE352E; }
    .line-4, .line-5, .line-6 { background: #00933C; }
    .line-7 { background: #B933AD; }
    .line-L { background: #A7A9AC; }
    .line-S, .line-FS, .line-H { background: #808183; }
    .line-J, .line-Z { background: #996633; }

    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      background: white;
    }

    .btn {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      margin-top: 16px;
    }

    .btn:hover {
      background: #1557b0;
    }

    .status {
      padding: 12px;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }

    .station-count {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 8px;
    }

    .help-text {
      font-size: 0.8rem;
      color: #888;
      margin-top: 4px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      cursor: pointer;
    }

    .toggle-row input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Settings</h1>
      <a href="index.html">← Back to Results</a>
    </header>

    <div id="loading" class="loading">Loading stations...</div>

    <div id="content" style="display: none;">
      <!-- API Keys -->
      <div class="card">
        <h2>API Keys</h2>
        <div class="input-group">
          <label>OpenWeatherMap API Key</label>
          <input type="text" id="apiKey" class="api-input" placeholder="For weather data">
          <div class="help-text">Get free key at <a href="https://openweathermap.org/api" target="_blank">openweathermap.org</a></div>
        </div>
        <div class="input-group">
          <label>Google API Key (optional)</label>
          <input type="text" id="googleKey" class="api-input" placeholder="For live transit directions">
          <div class="help-text">Get key at <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>. Enable Geocoding + Routes API.</div>
        </div>
        <div class="input-group">
          <label>Directions Worker URL (optional)</label>
          <input type="text" id="workerUrl" class="api-input" placeholder="https://commute-directions.your-account.workers.dev">
          <div class="help-text">Cloudflare Worker to proxy Google Directions API. See <code>cloudflare-worker/</code> to deploy. Both this URL and Google API key are needed for live transit times.</div>
        </div>
      </div>

      <!-- Display Options -->
      <div class="card">
        <h2>Display Options</h2>
        <label class="toggle-row">
          <input type="checkbox" id="showBikeOptions" checked>
          <span>Show bike-to-transit options</span>
        </label>
      </div>

      <!-- Home Location -->
      <div class="card">
        <h2>Home Location</h2>
        <div class="input-group">
          <label>Address</label>
          <div class="address-row">
            <input type="text" id="homeAddress" class="address-input" placeholder="123 Main St, Brooklyn, NY">
            <button class="btn-lookup" onclick="geocodeAddress('home')">Lookup</button>
          </div>
        </div>
        <div id="homeGeoStatus" class="geocode-status"></div>
        <div class="coords-row">
          <div class="input-group">
            <label>Latitude</label>
            <input type="number" id="homeLat" step="0.000001" placeholder="40.6892">
          </div>
          <div class="input-group">
            <label>Longitude</label>
            <input type="number" id="homeLng" step="0.000001" placeholder="-73.9544">
          </div>
        </div>
      </div>

      <!-- Work Location -->
      <div class="card">
        <h2>Work Location</h2>
        <div class="input-group">
          <label>Address</label>
          <div class="address-row">
            <input type="text" id="workAddress" class="address-input" placeholder="456 Office Ave, Manhattan, NY">
            <button class="btn-lookup" onclick="geocodeAddress('work')">Lookup</button>
          </div>
        </div>
        <div id="workGeoStatus" class="geocode-status"></div>
        <div class="coords-row">
          <div class="input-group">
            <label>Latitude</label>
            <input type="number" id="workLat" step="0.000001" placeholder="40.7471">
          </div>
          <div class="input-group">
            <label>Longitude</label>
            <input type="number" id="workLng" step="0.000001" placeholder="-73.9456">
          </div>
        </div>
      </div>

      <!-- Live Train Stations -->
      <div class="card">
        <h2>Live Train Stations</h2>
        <p>Select up to 3 stations for the Live Trains page</p>
        <div class="search-box">
          <input type="text" id="liveSearch" placeholder="Search stations..." oninput="filterStations('live')">
        </div>
        <div id="liveStationCount" class="station-count"></div>
        <div id="liveStations" class="station-list"></div>
      </div>

      <button class="btn" onclick="saveSettings()">Save Settings</button>

      <div id="status" class="status"></div>
    </div>
  </div>

  <script src="auto-select.js"></script>
  <script>
    let STATIONS = [];
    const STORAGE_KEY = 'commuteOptimizerSettings';
    const GEOCODE_API = 'https://api.openweathermap.org/geo/1.0/direct';

    async function loadStations() {
      try {
        const response = await fetch('stations.json');
        const data = await response.json();
        STATIONS = data.stations || data;  // Handle wrapped or raw array format
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        init();
      } catch (e) {
        document.getElementById('loading').textContent = 'Failed to load stations. Please refresh.';
      }
    }

    function loadSettings() {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : {};
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      if (!lat1 || !lng1) return 999;
      const R = 3959;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    async function geocodeAddress(type) {
      const addressInput = document.getElementById(`${type}Address`);
      const latInput = document.getElementById(`${type}Lat`);
      const lngInput = document.getElementById(`${type}Lng`);
      const statusEl = document.getElementById(`${type}GeoStatus`);
      const googleKey = document.getElementById('googleKey').value.trim();
      const owmKey = document.getElementById('apiKey').value.trim();

      const address = addressInput.value.trim();

      if (!address) {
        statusEl.className = 'geocode-status error';
        statusEl.textContent = 'Please enter an address.';
        return;
      }

      statusEl.className = 'geocode-status loading';
      statusEl.textContent = 'Looking up address...';

      try {
        let lat, lng, locationName;

        // Use Google Geocoding if key available (more accurate), else OpenWeatherMap
        if (googleKey) {
          const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${googleKey}`;
          const response = await fetch(url);
          const data = await response.json();

          if (data.status !== 'OK' || !data.results?.length) {
            statusEl.className = 'geocode-status error';
            statusEl.textContent = data.error_message || 'Address not found.';
            return;
          }

          const result = data.results[0];
          lat = result.geometry.location.lat;
          lng = result.geometry.location.lng;
          locationName = result.formatted_address;
        } else if (owmKey) {
          const url = `${GEOCODE_API}?q=${encodeURIComponent(address)}&limit=1&appid=${owmKey}`;
          const response = await fetch(url);
          const data = await response.json();

          if (data.length === 0) {
            statusEl.className = 'geocode-status error';
            statusEl.textContent = 'Address not found. Try adding city/state, or add Google API key for better results.';
            return;
          }

          const result = data[0];
          lat = result.lat;
          lng = result.lon;
          locationName = [result.name, result.state, result.country].filter(Boolean).join(', ');
        } else {
          statusEl.className = 'geocode-status error';
          statusEl.textContent = 'Please enter a Google or OpenWeatherMap API key first.';
          return;
        }

        latInput.value = lat.toFixed(6);
        lngInput.value = lng.toFixed(6);
        statusEl.className = 'geocode-status success';
        statusEl.textContent = `Found: ${locationName}`;

        if (type === 'home') {
          renderStations(loadSettings());
        }
      } catch (error) {
        statusEl.className = 'geocode-status error';
        statusEl.textContent = `Lookup failed: ${error.message}`;
      }
    }

    function init() {
      const settings = loadSettings();

      document.getElementById('apiKey').value = settings.apiKey || '';
      document.getElementById('googleKey').value = settings.googleKey || '';
      document.getElementById('workerUrl').value = settings.workerUrl || '';
      document.getElementById('showBikeOptions').checked = settings.showBikeOptions ?? true;
      document.getElementById('homeAddress').value = settings.homeAddress || '';
      document.getElementById('homeLat').value = settings.homeLat || '';
      document.getElementById('homeLng').value = settings.homeLng || '';
      document.getElementById('workAddress').value = settings.workAddress || '';
      document.getElementById('workLat').value = settings.workLat || '';
      document.getElementById('workLng').value = settings.workLng || '';

      renderStations(settings);

      document.getElementById('homeLat').addEventListener('change', () => renderStations(loadSettings()));
      document.getElementById('homeLng').addEventListener('change', () => renderStations(loadSettings()));
      document.getElementById('workLat').addEventListener('change', () => renderStations(loadSettings()));
      document.getElementById('workLng').addEventListener('change', () => renderStations(loadSettings()));
    }

    function getStationsWithDistance(settings) {
      const homeLat = parseFloat(document.getElementById('homeLat').value) || settings.homeLat || 0;
      const homeLng = parseFloat(document.getElementById('homeLng').value) || settings.homeLng || 0;

      return STATIONS.map(s => ({
        ...s,
        distance: calculateDistance(homeLat, homeLng, s.lat, s.lng)
      })).sort((a, b) => a.distance - b.distance);
    }

    function renderStations(settings, bikeFilter = '', liveFilter = '') {
      const stationsWithDist = getStationsWithDistance(settings);
      const liveStations = settings.liveStations || [];

      // Live stations
      const liveContainer = document.getElementById('liveStations');
      const liveFiltered = stationsWithDist.filter(s =>
        s.name.toLowerCase().includes(liveFilter.toLowerCase()) ||
        s.lines.some(l => l.toLowerCase().includes(liveFilter.toLowerCase()))
      );

      document.getElementById('liveStationCount').textContent =
        `${liveStations.length}/3 selected • ${liveFiltered.length} shown`;

      liveContainer.innerHTML = liveFiltered.slice(0, 100).map(s => `
        <label class="station-item">
          <input type="checkbox" name="liveStation" value="${s.id}"
            ${liveStations.includes(s.id) ? 'checked' : ''}
            onchange="checkLiveLimit(this)">
          <div class="station-info">
            <div class="station-name">${s.name}</div>
            <div class="station-meta">
              <span class="station-lines">
                ${s.lines.slice(0, 6).map(l => `<span class="line-badge line-${l}">${l}</span>`).join('')}
              </span>
              • ${s.borough || ''}
            </div>
          </div>
          <div class="station-distance">${s.distance < 100 ? s.distance.toFixed(1) + ' mi' : '--'}</div>
        </label>
      `).join('');
    }

    function filterStations(type) {
      const filter = document.getElementById('liveSearch').value;
      const settings = loadSettings();
      renderStations(settings, '', filter);
    }

    function checkLiveLimit(checkbox) {
      const checked = document.querySelectorAll('input[name="liveStation"]:checked');
      if (checked.length > 3) {
        checkbox.checked = false;
        alert('You can select up to 3 stations.');
      }
      document.getElementById('liveStationCount').textContent =
        `${Math.min(checked.length, 3)}/3 selected`;
    }

    function saveSettings() {
      const status = document.getElementById('status');

      const settings = {
        apiKey: document.getElementById('apiKey').value.trim(),
        googleKey: document.getElementById('googleKey').value.trim(),
        workerUrl: document.getElementById('workerUrl').value.trim(),
        showBikeOptions: document.getElementById('showBikeOptions').checked,
        homeAddress: document.getElementById('homeAddress').value.trim(),
        homeLat: parseFloat(document.getElementById('homeLat').value) || 0,
        homeLng: parseFloat(document.getElementById('homeLng').value) || 0,
        workAddress: document.getElementById('workAddress').value.trim(),
        workLat: parseFloat(document.getElementById('workLat').value) || 0,
        workLng: parseFloat(document.getElementById('workLng').value) || 0,
        liveStations: Array.from(document.querySelectorAll('input[name="liveStation"]:checked'))
          .map(el => el.value).slice(0, 3)
      };

      if (!settings.homeLat || !settings.homeLng) {
        status.className = 'status error';
        status.textContent = 'Please enter home coordinates (use Lookup button).';
        return;
      }

      if (!settings.workLat || !settings.workLng) {
        status.className = 'status error';
        status.textContent = 'Please enter work coordinates (use Lookup button).';
        return;
      }

      localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));

      status.className = 'status success';
      status.textContent = 'Settings saved!';

      setTimeout(() => { status.className = 'status'; }, 3000);
    }

    loadStations();
  </script>
</body>
</html>
